/*
powerfullz çš„ Substore è®¢é˜…è½¬æ¢è„šæœ¬ (æ—¥å¸¸ä½¿ç”¨ä¼˜åŒ–ç‰ˆ)
ä¼˜åŒ–å†…å®¹ï¼šAI è‡ªåŠ¨é¿å¼€ä¸æ”¯æŒåŒºåŸŸã€å¢žåŠ  Disney+ã€Apple/å¾®è½¯ç›´è¿žä¼˜åŒ–ã€TG è‡ªåŠ¨æµ‹é€Ÿã€ç­–ç•¥ç»„åµŒå¥—ä¼˜åŒ–
ä¿®æ”¹å†…å®¹ï¼š
1. å·²å¼ºåˆ¶å…³é—­ QUIC å’Œ IPv6
2. èŠ‚ç‚¹åˆ†ç»„åç§°å¢žåŠ å›½æ——å›¾æ ‡ (e.g., ðŸ‡­ðŸ‡° é¦™æ¸¯èŠ‚ç‚¹)

æ”¯æŒçš„ä¼ å…¥å‚æ•°ï¼š
- loadbalance: å¯ç”¨è´Ÿè½½å‡è¡¡ï¼ˆurl-test/load-balanceï¼Œé»˜è®¤ falseï¼‰
- landing: å¯ç”¨è½åœ°èŠ‚ç‚¹åŠŸèƒ½ï¼ˆé»˜è®¤ falseï¼‰
- full: è¾“å‡ºå®Œæ•´é…ç½®ï¼ˆé»˜è®¤ falseï¼‰
- keepalive: å¯ç”¨ tcp-keep-aliveï¼ˆé»˜è®¤ falseï¼‰
- fakeip: DNS ä½¿ç”¨ FakeIP æ¨¡å¼ï¼ˆé»˜è®¤ falseï¼‰
- threshold: å›½å®¶èŠ‚ç‚¹æ•°é‡å°äºŽè¯¥å€¼æ—¶ä¸æ˜¾ç¤ºåˆ†ç»„ (é»˜è®¤ 0)
* æ³¨æ„ï¼šipv6 å’Œ quic å‚æ•°å·²è¢«ç¦ç”¨ï¼Œå¼ºåˆ¶ä¸º false *
*/

const NODE_SUFFIX = "èŠ‚ç‚¹";

function parseBool(value) {
    if (typeof value === "boolean") return value;
    if (typeof value === "string") {
        return value.toLowerCase() === "true" || value === "1";
    }
    return false;
}

function parseNumber(value, defaultValue = 0) {
    if (value === null || typeof value === 'undefined') {
        return defaultValue;
    }
    const num = parseInt(value, 10);
    return isNaN(num) ? defaultValue : num;
}

function buildFeatureFlags(args) {
    const spec = {
        loadbalance: "loadBalance",
        landing: "landing",
        // ipv6: "ipv6Enabled", 
        full: "fullConfig",
        keepalive: "keepAliveEnabled",
        fakeip: "fakeIPEnabled",
        // quic: "quicEnabled"
    };

    const flags = Object.entries(spec).reduce((acc, [sourceKey, targetKey]) => {
        acc[targetKey] = parseBool(args[sourceKey]) || false;
        return acc;
    }, {});
    
    // --- å¼ºåˆ¶ä¿®æ”¹åŒºåŸŸ ---
    flags.ipv6Enabled = false; 
    flags.quicEnabled = false; 
    // ------------------

    flags.countryThreshold = parseNumber(args.threshold, 0);
    return flags;
}

const rawArgs = typeof $arguments !== 'undefined' ? $arguments : {};
const {
    loadBalance,
    landing,
    ipv6Enabled,
    fullConfig,
    keepAliveEnabled,
    fakeIPEnabled,
    quicEnabled,
    countryThreshold
} = buildFeatureFlags(rawArgs);

// å®šä¹‰å¸¦å›½æ——çš„å…ƒæ•°æ®
const countriesMeta = {
    "é¦™æ¸¯": { flag: "ðŸ‡­ðŸ‡°", pattern: "(?i)é¦™æ¸¯|æ¸¯|HK|hk|Hong Kong|HongKong|hongkong|ðŸ‡­ðŸ‡°", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Hong_Kong.png" },
    "æ¾³é—¨": { flag: "ðŸ‡²ðŸ‡´", pattern: "(?i)æ¾³é—¨|MO|Macau|ðŸ‡²ðŸ‡´", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Macao.png" },
    "å°æ¹¾": { flag: "ðŸ‡¹ðŸ‡¼", pattern: "(?i)å°|æ–°åŒ—|å½°åŒ–|TW|Taiwan|ðŸ‡¹ðŸ‡¼", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Taiwan.png" },
    "æ–°åŠ å¡": { flag: "ðŸ‡¸ðŸ‡¬", pattern: "(?i)æ–°åŠ å¡|å¡|ç‹®åŸŽ|SG|Singapore|ðŸ‡¸ðŸ‡¬", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Singapore.png" },
    "æ—¥æœ¬": { flag: "ðŸ‡¯ðŸ‡µ", pattern: "(?i)æ—¥æœ¬|å·æ—¥|ä¸œäº¬|å¤§é˜ª|æ³‰æ—¥|åŸ¼çŽ‰|æ²ªæ—¥|æ·±æ—¥|JP|Japan|ðŸ‡¯ðŸ‡µ", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Japan.png" },
    "éŸ©å›½": { flag: "ðŸ‡°ðŸ‡·", pattern: "(?i)KR|Korea|KOR|é¦–å°”|éŸ©|éŸ“|ðŸ‡°ðŸ‡·", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Korea.png" },
    "ç¾Žå›½": { flag: "ðŸ‡ºðŸ‡¸", pattern: "(?i)ç¾Žå›½|ç¾Ž|US|United States|ðŸ‡ºðŸ‡¸", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/United_States.png" },
    "åŠ æ‹¿å¤§": { flag: "ðŸ‡¨ðŸ‡¦", pattern: "(?i)åŠ æ‹¿å¤§|Canada|CA|ðŸ‡¨ðŸ‡¦", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Canada.png" },
    "è‹±å›½": { flag: "ðŸ‡¬ðŸ‡§", pattern: "(?i)è‹±å›½|United Kingdom|UK|ä¼¦æ•¦|London|ðŸ‡¬ðŸ‡§", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/United_Kingdom.png" },
    "æ¾³å¤§åˆ©äºš": { flag: "ðŸ‡¦ðŸ‡º", pattern: "(?i)æ¾³æ´²|æ¾³å¤§åˆ©äºš|AU|Australia|ðŸ‡¦ðŸ‡º", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Australia.png" },
    "å¾·å›½": { flag: "ðŸ‡©ðŸ‡ª", pattern: "(?i)å¾·å›½|å¾·|DE|Germany|ðŸ‡©ðŸ‡ª", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Germany.png" },
    "æ³•å›½": { flag: "ðŸ‡«ðŸ‡·", pattern: "(?i)æ³•å›½|æ³•|FR|France|ðŸ‡«ðŸ‡·", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/France.png" },
    "ä¿„ç½—æ–¯": { flag: "ðŸ‡·ðŸ‡º", pattern: "(?i)ä¿„ç½—æ–¯|ä¿„|RU|Russia|ðŸ‡·ðŸ‡º", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Russia.png" },
    "æ³°å›½": { flag: "ðŸ‡¹ðŸ‡­", pattern: "(?i)æ³°å›½|æ³°|TH|Thailand|ðŸ‡¹ðŸ‡­", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Thailand.png" },
    "å°åº¦": { flag: "ðŸ‡®ðŸ‡³", pattern: "(?i)å°åº¦|IN|India|ðŸ‡®ðŸ‡³", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/India.png" },
    "é©¬æ¥è¥¿äºš": { flag: "ðŸ‡²ðŸ‡¾", pattern: "(?i)é©¬æ¥è¥¿äºš|é©¬æ¥|MY|Malaysia|ðŸ‡²ðŸ‡¾", icon: "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Malaysia.png" },
};

function getCountryGroupNames(countryInfo, minCount) {
    return countryInfo
        .filter(item => item.count >= minCount)
        .map(item => {
            const flag = countriesMeta[item.country].flag;
            // æ ¼å¼ï¼š ðŸ‡­ðŸ‡° é¦™æ¸¯èŠ‚ç‚¹
            return `${flag} ${item.country}${NODE_SUFFIX}`;
        });
}

function stripNodeSuffix(groupNames) {
    const suffixPattern = new RegExp(`${NODE_SUFFIX}$`);
    return groupNames.map(name => {
        // 1. åŽ»æŽ‰åŽç¼€ "èŠ‚ç‚¹" -> "ðŸ‡­ðŸ‡° é¦™æ¸¯"
        const raw = name.replace(suffixPattern, "");
        // 2. åŽ»æŽ‰å‰é¢çš„å›½æ——å’Œç©ºæ ¼ (é€šè¿‡åˆ†å‰²ç©ºæ ¼å–æœ€åŽä¸€éƒ¨åˆ†ï¼Œé€‚åº”ä¸­æ–‡é”®å)
        // é”®åä¸º"é¦™æ¸¯"ï¼ŒsplitåŽå–æœ€åŽä¸€ä½å³å¯
        const parts = raw.split(" ");
        return parts.length > 1 ? parts[1] : parts[0];
    });
}

const PROXY_GROUPS = {
    SELECT: "é€‰æ‹©ä»£ç†",
    MANUAL: "æ‰‹åŠ¨é€‰æ‹©",
    FALLBACK: "æ•…éšœè½¬ç§»",
    DIRECT: "ç›´è¿ž",
    LANDING: "è½åœ°èŠ‚ç‚¹",
    LOW_COST: "ä½Žå€çŽ‡èŠ‚ç‚¹",
    AUTO: "è‡ªåŠ¨é€‰æ‹©"
};

const buildList = (...elements) => elements.flat().filter(Boolean);

function buildBaseLists({ landing, lowCost, countryGroupNames }) {
    // åŸºç¡€å€™é€‰åˆ—è¡¨
    const defaultSelector = buildList(
        PROXY_GROUPS.FALLBACK,
        landing && PROXY_GROUPS.LANDING,
        countryGroupNames,
        lowCost && PROXY_GROUPS.LOW_COST,
        PROXY_GROUPS.MANUAL,
        "DIRECT"
    );

    const defaultProxies = buildList(
        PROXY_GROUPS.SELECT,
        countryGroupNames,
        lowCost && PROXY_GROUPS.LOW_COST,
        PROXY_GROUPS.MANUAL,
        PROXY_GROUPS.DIRECT
    );

    const defaultProxiesDirect = buildList(
        PROXY_GROUPS.DIRECT,
        countryGroupNames,
        lowCost && PROXY_GROUPS.LOW_COST,
        PROXY_GROUPS.SELECT,
        PROXY_GROUPS.MANUAL
    );

    const defaultFallback = buildList(
        landing && PROXY_GROUPS.LANDING,
        countryGroupNames,
        lowCost && PROXY_GROUPS.LOW_COST,
        PROXY_GROUPS.MANUAL,
        "DIRECT"
    );

    return { defaultProxies, defaultProxiesDirect, defaultSelector, defaultFallback };
}

const ruleProviders = {
    "ADBlock": {
        "type": "http",
        "behavior": "domain",
        "format": "mrs",
        "interval": 86400,
        "url": "https://adrules.top/adrules-mihomo.mrs",
        "path": "./ruleset/ADBlock.mrs"
    },
    "SogouInput": {
        "type": "http",
        "behavior": "classical",
        "format": "text",
        "interval": 86400,
        "url": "https://ruleset.skk.moe/Clash/non_ip/sogouinput.txt",
        "path": "./ruleset/SogouInput.txt"
    },
    "StaticResources": {
        "type": "http",
        "behavior": "domain",
        "format": "text",
        "interval": 86400,
        "url": "https://ruleset.skk.moe/Clash/domainset/cdn.txt",
        "path": "./ruleset/StaticResources.txt"
    },
    "CDNResources": {
        "type": "http",
        "behavior": "classical",
        "format": "text",
        "interval": 86400,
        "url": "https://ruleset.skk.moe/Clash/non_ip/cdn.txt",
        "path": "./ruleset/CDNResources.txt"
    },
    "TikTok": {
        "type": "http",
        "behavior": "classical",
        "format": "text",
        "interval": 86400,
        "url": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/TikTok.list",
        "path": "./ruleset/TikTok.list"
    },
    "EHentai": {
        "type": "http",
        "behavior": "classical",
        "format": "text",
        "interval": 86400,
        "url": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/EHentai.list",
        "path": "./ruleset/EHentai.list"
    },
    "SteamFix": {
        "type": "http",
        "behavior": "classical",
        "format": "text",
        "interval": 86400,
        "url": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/SteamFix.list",
        "path": "./ruleset/SteamFix.list"
    },
    "GoogleFCM": {
        "type": "http",
        "behavior": "classical",
        "format": "text",
        "interval": 86400,
        "url": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/FirebaseCloudMessaging.list",
        "path": "./ruleset/FirebaseCloudMessaging.list"
    },
    "AdditionalFilter": {
        "type": "http",
        "behavior": "classical",
        "format": "text",
        "interval": 86400,
        "url": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/AdditionalFilter.list",
        "path": "./ruleset/AdditionalFilter.list"
    },
    "AdditionalCDNResources": {
        "type": "http",
        "behavior": "classical",
        "format": "text",
        "interval": 86400,
        "url": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/AdditionalCDNResources.list",
        "path": "./ruleset/AdditionalCDNResources.list"
    },
    "Crypto": {
        "type": "http",
        "behavior": "classical",
        "format": "text",
        "interval": 86400,
        "url": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/Crypto.list",
        "path": "./ruleset/Crypto.list"
    }
}

// ä¼˜åŒ–åŽçš„è§„åˆ™é›†
const baseRules = [
    `RULE-SET,ADBlock,å¹¿å‘Šæ‹¦æˆª`,
    `RULE-SET,AdditionalFilter,å¹¿å‘Šæ‹¦æˆª`,
    `RULE-SET,SogouInput,æœç‹—è¾“å…¥æ³•`,
    // ç¤¾äº¤ä¸Žåª’ä½“
    `DOMAIN-SUFFIX,truthsocial.com,Truth Social`,
    `RULE-SET,TikTok,TikTok`,
    `RULE-SET,EHentai,E-Hentai`,
    // é™æ€èµ„æºä¸Žç›´è¿žä¼˜åŒ–
    `RULE-SET,StaticResources,é™æ€èµ„æº`,
    `RULE-SET,CDNResources,é™æ€èµ„æº`,
    `RULE-SET,AdditionalCDNResources,é™æ€èµ„æº`,
    // æ¸¸æˆä¸Žåº”ç”¨æœåŠ¡
    `RULE-SET,SteamFix,${PROXY_GROUPS.DIRECT}`,
    `RULE-SET,GoogleFCM,${PROXY_GROUPS.DIRECT}`,
    `DOMAIN,services.googleapis.cn,${PROXY_GROUPS.SELECT}`,
    `GEOSITE,GOOGLE-PLAY@CN,${PROXY_GROUPS.DIRECT}`,
    // è‹¹æžœä¸Žå¾®è½¯ä¼˜åŒ– (ç›´è¿žä»¥åŠ é€Ÿä¸‹è½½å’ŒèŠ‚çœæµé‡)
    `GEOSITE,APPLE,${PROXY_GROUPS.DIRECT}`,
    `GEOSITE,MICROSOFT,${PROXY_GROUPS.DIRECT}`,
    // AI æœåŠ¡
    "GEOSITE,CATEGORY-AI-!CN,AI",
    // å›½é™…æµåª’ä½“
    "GEOSITE,NETFLIX,Netflix",
    "GEOSITE,DISNEY,Disney+",
    "GEOSITE,YOUTUBE,YouTube",
    "GEOSITE,SPOTIFY,Spotify",
    "GEOSITE,PIKPAK,PikPak",
    // ç¤¾äº¤
    "GEOSITE,TELEGRAM,Telegram",
    // åœ°åŒºæµåª’ä½“
    "GEOSITE,BAHAMUT,Bahamut",
    "GEOSITE,BILIBILI,Bilibili",
    // å…œåº•è§„åˆ™
    `GEOSITE,GFW,${PROXY_GROUPS.SELECT}`,
    `GEOSITE,CN,${PROXY_GROUPS.DIRECT}`,
    `GEOSITE,PRIVATE,${PROXY_GROUPS.DIRECT}`,
    "GEOIP,NETFLIX,Netflix,no-resolve",
    "GEOIP,TELEGRAM,Telegram,no-resolve",
    `GEOIP,CN,${PROXY_GROUPS.DIRECT}`,
    `GEOIP,PRIVATE,${PROXY_GROUPS.DIRECT}`,
    "DST-PORT,22,SSH(22ç«¯å£)",
    `MATCH,${PROXY_GROUPS.SELECT}`
];

function buildRules({ quicEnabled }) {
    const ruleList = [...baseRules];
    if (!quicEnabled) {
        // å¼ºåˆ¶å…³é—­ QUIC æ—¶ï¼Œæ·»åŠ é˜»æ–­ UDP 443 è§„åˆ™
        ruleList.unshift("AND,((DST-PORT,443),(NETWORK,UDP)),REJECT");
    }
    return ruleList;
}

const snifferConfig = {
    "sniff": {
        "TLS": { "ports": [443, 8443] },
        "HTTP": { "ports": [80, 8080, 8880] },
        "QUIC": { "ports": [443, 8443] }
    },
    "override-destination": false,
    "enable": true,
    "force-dns-mapping": true,
    "skip-domain": ["Mijia Cloud", "dlg.io.mi.com", "+.push.apple.com"]
};

function buildDnsConfig({ mode, fakeIpFilter }) {
    const config = {
        "enable": true,
        "ipv6": ipv6Enabled, // å¼ºåˆ¶ä¸º false
        "prefer-h3": true,
        "enhanced-mode": mode,
        "default-nameserver": ["119.29.29.29", "223.5.5.5"],
        "nameserver": ["system", "223.5.5.5", "119.29.29.29", "180.184.1.1"],
        "fallback": ["https://1.1.1.1/dns-query", "https://dns.google/dns-query", "https://dns.cloudflare.com/dns-query", "tcp://208.67.222.222"],
        "proxy-server-nameserver": ["https://dns.alidns.com/dns-query", "tls://dot.pub"]
    };
    if (fakeIpFilter) config["fake-ip-filter"] = fakeIpFilter;
    return config;
}

const dnsConfig = buildDnsConfig({ mode: "redir-host" });
const dnsConfigFakeIp = buildDnsConfig({
    mode: "fake-ip",
    fakeIpFilter: [
        "geosite:private", "geosite:connectivity-check", "geosite:cn",
        "Mijia Cloud", "dig.io.mi.com", "localhost.ptlogin2.qq.com",
        "*.icloud.com", "*.stun.*.*", "*.stun.*.*.*"
    ]
});

const geoxURL = {
    "geoip": "https://gcore.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geoip.dat",
    "geosite": "https://gcore.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat",
    "mmdb": "https://gcore.jsdelivr.net/gh/Loyalsoldier/geoip@release/Country.mmdb",
    "asn": "https://gcore.jsdelivr.net/gh/Loyalsoldier/geoip@release/GeoLite2-ASN.mmdb"
};

function hasLowCost(config) {
    const lowCostRegex = /0\.[0-5]|ä½Žå€çŽ‡|çœæµ|å¤§æµé‡|å®žéªŒæ€§/i;
    return (config.proxies || []).some(proxy => lowCostRegex.test(proxy.name));
}

function parseCountries(config) {
    const proxies = config.proxies || [];
    const ispRegex = /å®¶å®½|å®¶åº­|å®¶åº­å®½å¸¦|å•†å®½|å•†ä¸šå®½å¸¦|æ˜Ÿé“¾|Starlink|è½åœ°/i;
    const countryCounts = Object.create(null);
    const compiledRegex = {};
    for (const [country, meta] of Object.entries(countriesMeta)) {
        compiledRegex[country] = new RegExp(meta.pattern.replace(/^\(\?i\)/, ''), 'i');
    }
    for (const proxy of proxies) {
        const name = proxy.name || '';
        if (ispRegex.test(name)) continue;
        for (const [country, regex] of Object.entries(compiledRegex)) {
            if (regex.test(name)) {
                countryCounts[country] = (countryCounts[country] || 0) + 1;
                break;
            }
        }
    }
    const result = [];
    for (const [country, count] of Object.entries(countryCounts)) {
        result.push({ country, count });
    }
    return result;
}

function buildCountryProxyGroups({ countries, landing, loadBalance }) {
    const groups = [];
    const baseExcludeFilter = "0\\.[0-5]|ä½Žå€çŽ‡|çœæµ|å¤§æµé‡|å®žéªŒæ€§";
    const landingExcludeFilter = "(?i)å®¶å®½|å®¶åº­|å®¶åº­å®½å¸¦|å•†å®½|å•†ä¸šå®½å¸¦|æ˜Ÿé“¾|Starlink|è½åœ°";
    const groupType = loadBalance ? "load-balance" : "url-test";
    for (const country of countries) {
        const meta = countriesMeta[country];
        if (!meta) continue;
        
        // æž„é€ å¸¦å›½æ——çš„åç§°
        const groupName = `${meta.flag} ${country}${NODE_SUFFIX}`;
        
        const groupConfig = {
            "name": groupName,
            "icon": meta.icon,
            "include-all": true,
            "filter": meta.pattern,
            "exclude-filter": landing ? `${landingExcludeFilter}|${baseExcludeFilter}` : baseExcludeFilter,
            "type": groupType
        };
        if (!loadBalance) {
            Object.assign(groupConfig, { "url": "https://cp.cloudflare.com/generate_204", "interval": 60, "tolerance": 20, "lazy": false });
        }
        groups.push(groupConfig);
    }
    return groups;
}

function buildProxyGroups({
    landing,
    countries,
    countryProxyGroups,
    lowCost,
    defaultProxies,
    defaultProxiesDirect,
    defaultSelector,
    defaultFallback
}) {
    const hasTW = countries.includes("å°æ¹¾");
    const hasHK = countries.includes("é¦™æ¸¯");
    const hasUS = countries.includes("ç¾Žå›½");
     
    // è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹ï¼ˆå‰”é™¤ä¸å¯ç”¨åŒºåŸŸï¼‰
    // AI å‰”é™¤ HK, MO, CN, RU
    const aiFilter = /é¦™æ¸¯|HK|Hong Kong|ä¸­å›½|CN|China|æ¾³é—¨|MO|Macao|ä¿„ç½—æ–¯|RU/i;
    const aiProxies = defaultProxies.filter(n => !aiFilter.test(n));

    const frontProxySelector = landing
        ? defaultSelector.filter(name => name !== PROXY_GROUPS.LANDING && name !== PROXY_GROUPS.FALLBACK)
        : [];
        
    // æŸ¥æ‰¾å¸¦å›½æ——çš„èŠ‚ç‚¹åå‡½æ•°
    const findGroup = (keyword) => {
        // åœ¨ defaultProxies ä¸­å¯»æ‰¾åŒ…å«å…³é”®è¯ï¼ˆå¦‚"å°æ¹¾"ï¼‰çš„ç»„å
        return defaultProxiesDirect.find(n => n.includes(keyword)) || keyword + NODE_SUFFIX;
    };

    return [
        {
            "name": PROXY_GROUPS.SELECT,
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Proxy.png",
            "type": "select",
            "proxies": defaultSelector
        },
        {
            "name": PROXY_GROUPS.MANUAL,
            "icon": "https://gcore.jsdelivr.net/gh/shindgewongxj/WHATSINStash@master/icon/select.png",
            "include-all": true,
            "type": "select"
        },
        // è‡ªåŠ¨æµ‹é€Ÿç»„ (AUTO)
        {
            "name": PROXY_GROUPS.AUTO,
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Speedtest.png",
            "type": "url-test",
            "url": "https://cp.cloudflare.com/generate_204",
            "interval": 120,
            "tolerance": 50,
            "include-all": true,
            "exclude-filter": "(?i)å®¶å®½|å®¶åº­|å•†å®½|è½åœ°|0\.[0-5]|ä½Žå€çŽ‡"
        },
        (landing) ? {
            "name": "å‰ç½®ä»£ç†",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Area.png",
            "type": "select",
            "include-all": true,
            "exclude-filter": "(?i)å®¶å®½|å®¶åº­|å®¶åº­å®½å¸¦|å•†å®½|å•†ä¸šå®½å¸¦|æ˜Ÿé“¾|Starlink|è½åœ°",
            "proxies": frontProxySelector
        } : null,
        (landing) ? {
            "name": PROXY_GROUPS.LANDING,
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Airport.png",
            "type": "select",
            "include-all": true,
            "filter": "(?i)å®¶å®½|å®¶åº­|å®¶åº­å®½å¸¦|å•†å®½|å•†ä¸šå®½å¸¦|æ˜Ÿé“¾|Starlink|è½åœ°",
        } : null,
        {
            "name": PROXY_GROUPS.FALLBACK,
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Bypass.png",
            "type": "fallback",
            "url": "https://cp.cloudflare.com/generate_204",
            "proxies": defaultFallback,
            "interval": 180,
            "tolerance": 20,
            "lazy": false
        },
        {
            "name": "AI",
            "icon": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/icons/chatgpt.png",
            "type": "select",
            "proxies": aiProxies.length > 0 ? aiProxies : defaultProxies
        },
        {
            "name": "Telegram",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Telegram.png",
            "type": "select",
            "proxies": [PROXY_GROUPS.AUTO, ...defaultProxies]
        },
        {
            "name": "YouTube",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/YouTube.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "Netflix",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Netflix.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "Disney+",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Disney.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "Bilibili",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/bilibili.png",
            "type": "select",
            "proxies": (hasTW && hasHK) ? [PROXY_GROUPS.DIRECT, findGroup("å°æ¹¾"), findGroup("é¦™æ¸¯")] : defaultProxiesDirect
        },
        {
            "name": "Bahamut",
            "icon": "https://cdn.jsdmirror.com/gh/Koolson/Qure@master/IconSet/Color/Bahamut.png",
            "type": "select",
            "proxies": (hasTW) ? [findGroup("å°æ¹¾"), PROXY_GROUPS.SELECT, PROXY_GROUPS.MANUAL, PROXY_GROUPS.DIRECT] : defaultProxies
        },
        {
            "name": "TikTok",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/TikTok.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "Spotify",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Spotify.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "PikPak",
            "icon": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/icons/PikPak.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "Truth Social",
            "icon": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/icons/TruthSocial.png",
            "type": "select",
            "proxies": (hasUS) ? [findGroup("ç¾Žå›½"), PROXY_GROUPS.SELECT, PROXY_GROUPS.MANUAL] : defaultProxies
        },
        {
            "name": "Crypto",
            "icon": "https://cdn.jsdmirror.com/gh/Koolson/Qure@master/IconSet/Color/Cryptocurrency_3.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "SSH(22ç«¯å£)",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Server.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "é™æ€èµ„æº",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Cloudflare.png",
            "type": "select",
            "proxies": defaultProxies,
        },
        {
            "name": "æœç‹—è¾“å…¥æ³•",
            "icon": "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/icons/Sougou.png",
            "type": "select",
            "proxies": [PROXY_GROUPS.DIRECT, "REJECT", PROXY_GROUPS.MANUAL]
        },
        {
            "name": PROXY_GROUPS.DIRECT,
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Direct.png",
            "type": "select",
            "proxies": ["DIRECT", PROXY_GROUPS.SELECT, PROXY_GROUPS.MANUAL]
        },
        {
            "name": "å¹¿å‘Šæ‹¦æˆª",
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/AdBlack.png",
            "type": "select",
            "proxies": ["REJECT", "REJECT-DROP", PROXY_GROUPS.DIRECT, PROXY_GROUPS.MANUAL]
        },
        (lowCost) ? {
            "name": PROXY_GROUPS.LOW_COST,
            "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Lab.png",
            "type": "url-test",
            "url": "https://cp.cloudflare.com/generate_204",
            "include-all": true,
            "filter": "(?i)0\.[0-5]|ä½Žå€çŽ‡|çœæµ|å¤§æµé‡|å®žéªŒæ€§"
        } : null,
        ...countryProxyGroups
    ].filter(Boolean);
}

function main(config) {
    const resultConfig = { proxies: config.proxies };
    const countryInfo = parseCountries(resultConfig);
    const lowCost = hasLowCost(resultConfig);
    const countryGroupNames = getCountryGroupNames(countryInfo, countryThreshold);
    const countries = stripNodeSuffix(countryGroupNames);

    const { defaultProxies, defaultProxiesDirect, defaultSelector, defaultFallback } = buildBaseLists({ landing, lowCost, countryGroupNames });
    const countryProxyGroups = buildCountryProxyGroups({ countries, landing, loadBalance });

    const proxyGroups = buildProxyGroups({
        landing,
        countries,
        countryProxyGroups,
        lowCost,
        defaultProxies,
        defaultProxiesDirect,
        defaultSelector,
        defaultFallback
    });
     
    const globalProxies = proxyGroups.map(item => item.name);  
    proxyGroups.push({
        "name": "GLOBAL",
        "icon": "https://gcore.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png",
        "include-all": true,
        "type": "select",
        "proxies": globalProxies
    });

    const finalRules = buildRules({ quicEnabled });

    if (fullConfig) Object.assign(resultConfig, {
        "mixed-port": 7890,
        "redir-port": 7892,
        "tproxy-port": 7893,
        "routing-mark": 7894,
        "allow-lan": true,
        "ipv6": ipv6Enabled,
        "mode": "rule",
        "unified-delay": true,
        "tcp-concurrent": true,
        "find-process-mode": "off",
        "log-level": "info",
        "geodata-loader": "standard",
        "external-controller": ":9999",
        "disable-keep-alive": !keepAliveEnabled,
        "profile": { "store-selected": true }
    });

    Object.assign(resultConfig, {
        "proxy-groups": proxyGroups,
        "rule-providers": ruleProviders,
        "rules": finalRules,
        "sniffer": snifferConfig,
        "dns": fakeIPEnabled ? dnsConfigFakeIp : dnsConfig,
        "geodata-mode": true,
        "geox-url": geoxURL,
    });

    return resultConfig;
}
